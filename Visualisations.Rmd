---
title: "Visualisations"
author: "Luke Hardwick, Adam Smit, Jess Part"
date: "2023-11-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library("tidyverse")
library("tidymodels")
library("xlsx")
```


```{r vis, out.width="100%"}
# Still Very much in the early stages. This should be taken as rough working.

Crimes_Region_County <- xlsx::read.xlsx("data/CSV/Crimes_by_County-Region.xlsx", sheetIndex = 4)
Crimes_Region_County <- na.omit(Crimes_Region_County)
colnames(Crimes_Region_County) <- Crimes_Region_County[1,]
Crimes_Region_County <- Crimes_Region_County[-c(1,2,3),]

col_int <- c(4,10,11,12,21,22,23,24,25)
col_names <- c("Violence against the person", "Sexual offences", "Robbery", "Theft offences", 
               "Criminal damage and arson", "Drug offences", "Possesion of weapons offences", 
               "Public order offences", "Miscellaneous crimes") 

County_names <- Crimes_Region_County %>%
  filter(substr(`Area Code`, 1, 2) == "E2")

Region_names <- Crimes_Region_County %>% 
  filter(substr(`Area Code`, 1, 2) == "E1")

Region_names <- Region_names[2]
Region_names <- Region_names[,"Area Name"]
County_names <- County_names[2]
County_names <- County_names[,"Area Name"]

#Removes Violence and theft breakdown
Crimes_Region_County <- Crimes_Region_County[-c(5:9, 13:20)]


for(i in Region_names)
{
  
  crimes <- Crimes_Region_County %>% filter(`Area Name` == i)
  crimes <- crimes[c(1),]
  crimes <- crimes[-c(1,2,3)]
  
  df <- data.frame(matrix(ncol = 2, nrow = length(col_names)) )
  colnames(df) <- c("Crime", "Occurrences")
  
  for( j in c(1:length(col_names)) )
  {
    df[j,] <- c(col_names[j], as.numeric(crimes[j]))
  }
  
  df$Occurrences <- as.numeric(df$Occurrences)

  print(ggplot(df, aes(x = Crime, y = Occurrences, fill = Crime) ) + 
         geom_bar(stat = "identity") +
  scale_x_discrete(guide = guide_axis(n.dodge = 5)) + 
    labs(
      title = paste("Crime in", i)
    ))

}

####### Crime Rate 
Crimes_Region_County_Per <- xlsx::read.xlsx("data/CSV/Crimes_by_County-Region.xlsx", sheetIndex = 6)
Crimes_Region_County_Per <- na.omit(Crimes_Region_County_Per)
colnames(Crimes_Region_County_Per) <- Crimes_Region_County_Per[1,]
Crimes_Region_County_Per <- Crimes_Region_County_Per[-c(1,2,3),]

Crimes_Region_County_Per <- Crimes_Region_County_Per %>%
  filter( substr(`Area Code`, 1, 2) == "E2")

Crimes_Region_County_Per <- Crimes_Region_County_Per[c(2, 5)]

colnames(Crimes_Region_County_Per) <- c("County", "Crime rate (per 1000)")

####### Mean income

Economic <- readODS::read_ods("data/CSV/Economic_Stats.ods", sheet = 2)
Economic <- na.omit(Economic)
colnames(Economic) <- Economic[1,]
Economic <- Economic[-c(1,2,3),]

Economic <- Economic %>% 
  filter(substr(`Region / County codes`, 1, 3) != "E12" & substr(`Region / County codes`, 1, 2) == "E1")

Economic <- Economic[c(2, 16, 17)]
colnames(Economic) <- c("County", colnames(Economic)[2], colnames(Economic)[3])

df <- left_join(Crimes_Region_County_Per, Economic, by = "County")
df <- na.omit(df)
df <- arrange(df, desc(`Total income: Mean`))
df$`Crime rate (per 1000)` <- as.numeric(df$`Crime rate (per 1000)`)

### Mean income vs crime rate

ggplot(data = df, mapping = aes(x = `Total income: Mean`, y = `Crime rate (per 1000)`, label = `County`)) +
  geom_point() +
  scale_x_discrete(guide = guide_axis(n.dodge = 5)) + 
  labs(
    title = "Mean Income(£) vs Crime rate (Per 1000)",
    x = "Mean Income(£)",
    y = "Crime Rate (Per 1000)"
  ) + 
  geom_text(hjust = 0, vjust = 0)

### Median income vs crime rate

ggplot(data = df, mapping = aes(x = `Total income: Median`, y = `Crime rate (per 1000)`, label = `County`)) + 
  geom_point() + 
  scale_x_discrete(guide = guide_axis(n.dodge = 5)) + 
  labs(
    title = "Median Income(£) vs Crime Rate (Per 1000)",
    x = "Median Income(£)",
    y = "Crime Rate (Per 1000)"
  ) + 
  geom_text(hjust = 0, vjust = 0)

##################################

#### Other Crimes table

Crimes_County2 <- xlsx::read.xlsx("data/CSV/Crimes_County2.xlsx", sheetIndex = 2)
colnames(Crimes_County2) <- Crimes_County2[1,]

colnames(Crimes_County2)[4] = "Number"
Crimes_County2 <- Crimes_County2[-c(1,3)]
Crimes_County2 <- na.omit(Crimes_County2)
Crimes_County2 <- Crimes_County2 %>%
  filter(grepl("Total", `CSP`))

colnames(Crimes_County2)[1] <- "LC"

for(i in 1:nrow(Crimes_County2))
{
  Crimes_County2[i,][1] <- unlist(strsplit(as.character(Crimes_County2[i,][1]), split = " Total", fixed = TRUE))
}

Economic2 <- xlsx::read.xlsx("data/CSV/Weekly Pay.xlsx", sheetIndex = 2)

Economic2 <- na.omit(Economic2)

colnames(Economic2) <- Economic2[1,]
Economic2 <- Economic2[-c(1),]
colnames(Economic2)[1] <- c("LC") 

Economic2 <- Economic2 %>%
  filter(substr(`LC`, 1, 1) == " ")

for(i in c(1:nrow(Economic2)))
{
  Economic2[i,][1] <- unlist(strsplit(as.character(Economic2[i,][1]), split = " ", fixed = TRUE))[3]
}

pop_stats <-xlsx::read.xlsx("data/CSV/Population_Stats.xlsx", sheetIndex = 17)
pop_stats <- na.omit(pop_stats)
colnames(pop_stats) <- c("LC", "Population", "Median Age")

Crime_Factors <- left_join(Crimes_County2, Economic2, by = "LC")
Crime_Factors <- left_join(Crime_Factors, pop_stats, by = "LC")
Crime_Factors <- na.omit(Crime_Factors)

Crime_Factors <- Crime_Factors %>%
  mutate(Crime_rate = `Number`/`Population`)

Crime_Factors$Mean <- as.numeric(Crime_Factors$Mean) 
Crime_Factors$Median <- as.numeric(Crime_Factors$Median)

ggplot(data = Crime_Factors, mapping = aes(x = `Mean`, y = `Crime_rate`, label = `LC`)) + 
  geom_point() + 
  labs(
    title = "Mean weekly pay (£) vs Crime rate (Crimes per person)",
    x = "Mean weekly pay (£)",
    y = "Crime Rate"
  ) + 
    geom_smooth(method = lm, se = FALSE)


ggplot(data = Crime_Factors, mapping = aes(x = `Median`, y = `Crime_rate`, label = `LC`)) + 
  geom_point() + 
  labs(
    title = "Median weekly pay (£) vs Crime rate (Crimes per person)",
    x = "Median weekly pay (£)",
    y = "Crime Rate"
  ) + 
    geom_smooth(method = lm, se = FALSE)

##################################

### Poverty risk 

poverty_risk <- xlsx::read.xlsx("data/csv/poverty_risk.xlsx", sheetIndex = 1)

poverty_risk <- poverty_risk[c(1,3)]
colnames(poverty_risk) <- c("LC", "Poverty Risk") 

Crime_Factors <- left_join(Crime_Factors, poverty_risk, by = "LC")

Crime_Factors <- Crime_Factors %>%
  mutate(`Poverty Risk` = 327 - `Poverty Risk`)
## number of Local Authorities = 326

ggplot(data = Crime_Factors, mapping = aes(x = `Poverty Risk`, y = `Crime_rate`)) + 
  geom_point() + 
  geom_smooth(method = lm, se = FALSE)

### unemployment rate

unemply_rate <- xlsx::read.xlsx("data/CSV/employmentlasewcensus2021.xlsx", sheetIndex = 2)

unemply_rate <- na.omit(unemply_rate)
colnames(unemply_rate) <- unemply_rate[1,]
unemply_rate <- unemply_rate[-c(1),]
unemply_rate <-unemply_rate[-c(3,4)]
unemply_rate <- unemply_rate %>%
  filter(`Economic activity (high-level) status` == "Unemployed")

unemply_rate <- unemply_rate[-c(1)]
colnames(unemply_rate) <- c("LC", "Unemployment Rate")
unemply_rate$`Unemployment Rate` <- as.numeric(unemply_rate$`Unemployment Rate`)

Crime_Factors <- left_join(Crime_Factors, unemply_rate, by = "LC")

ggplot(data = Crime_Factors, mapping = aes(x = `Unemployment Rate`, y = `Crime_rate`)) +
  geom_point() +
  geom_smooth(method = lm, se = FALSE)

###### Divorce Rate

divorce_rate <- xlsx::read.xlsx("data/CSV/Divorce.xlsx", sheetIndex = 1)

divorce_rate <- divorce_rate[c(1,2)]
divorce_rate <- na.omit(divorce_rate)
divorce_rate <- divorce_rate[-c(1),]
colnames(divorce_rate) <- c("LC", "Divorce Rate")
divorce_rate$`Divorce Rate` <- as.numeric(divorce_rate$`Divorce Rate`) 

Crime_Factors <- left_join(Crime_Factors, divorce_rate, by = "LC")

ggplot(data = Crime_Factors, mapping = aes(x = `Divorce Rate`, y = `Crime_rate`)) + 
  geom_point() + 
  geom_smooth(method = lm, se = FALSE)


#### Ethnic Minority Population

ethnic <- xlsx::read.xlsx("data/CSV/ethnic.xlsx", sheetIndex = 2)

ethnic <- ethnic[c(2, 5)]
ethnic <- na.omit(ethnic)
colnames(ethnic) <- c("LC", "White British %")
ethnic <- ethnic[-c(1),] 

for(i in c(1:nrow(ethnic)))
{
  new <- unlist(strsplit(as.character(ethnic[i,][1]), split = " ", fixed = TRUE))
  ethnic[i,][1] <- new[length(new)]
}

ethnic$`White British %` <- as.numeric(ethnic$`White British %`)

ethnic$`White British %` <- 1000 * ethnic$`White British %`

Crime_Factors <- left_join(Crime_Factors, ethnic, by = "LC")

Crime_Factors <- Crime_Factors %>%
  mutate(`White British %` = (`White British %`/`Population`) * 100)

Crime_Factors <- Crime_Factors %>%
  mutate(`Non White British %` = 100 - `White British %`)


ggplot(data = Crime_Factors, mapping = aes(x = `Non White British %`, y = `Crime_rate`, label = `LC`)) + 
  geom_point() + 
  geom_smooth(method = lm, se = FALSE) + 
  labs(title = "% Ethnic Minority Population Vs Crime Rate (by Local Authority)",
       x = "% Non British White", y = "Crime Rate (per Capita)")

#Crime_Factors

### Religion

Religion <- xlsx::read.xlsx("data/CSV/ethnic.xlsx", sheetIndex = 3)

Religion <- Religion[c(2, 5, 12)]
Religion <- na.omit(Religion)

Religion <- Religion[-c(1),]
colnames(Religion) <-c("LC", "Christian", "Non-Religious")

for(i in c(1:nrow(Religion)))
{
  new <- unlist(strsplit(as.character(Religion[i,][1]), split = " ", fixed = TRUE))
  Religion[i,][1] <- new[length(new)]
}

Religion$`Christian` <- as.numeric(Religion$`Christian`)
Religion$`Non-Religious` <- as.numeric(Religion$`Non-Religious`)

Crime_Factors <- left_join(Crime_Factors, Religion, by = "LC")
Crime_Factors <- Crime_Factors %>%
  mutate(`% Minority Religion` = 100*(1 - (1000*(`Christian` + `Non-Religious`))/`Population`))

#Crime_Factors

ggplot(data = Crime_Factors, mapping = aes(x = `% Minority Religion`, y = `Crime_rate`)) + 
  geom_point() + 
  geom_smooth(method = lm, se = FALSE)

colnames(Crime_Factors)

Crime_Fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(`Crime_rate` ~ `Poverty Risk` + `Unemployment Rate` + `Divorce Rate` + 
        `Non White British %` + `% Minority Religion`, data = Crime_Factors)
tidy(Crime_Fit)

```


```{r load-data}




```
